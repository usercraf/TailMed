import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.exceptions import TelegramNetworkError
from aiogram.filters.command import Command
from aiogram.types import InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext

from key_file import TOKEN
from log_file import logger
from key_file import cur
from admin_file import admin_router
from user_file import user_router
from doctor_file import doctor_router
from test_file import test_router

bot = Bot(token=TOKEN)
dp = Dispatcher()


def get_admin_buttons():
    return {
        'add_doctor': 'üë®‚Äç‚öïÔ∏è –î–æ–¥–∞—Ç–∏ –ª—ñ–∫–∞—Ä—è',
        'del_doctor': 'ü§∑ –í–∏–¥–∞–ª–∏—Ç–∏ –ª—ñ–∫–∞—Ä—è',
    }

async def show_main_menu(user_id: int, user_name: str, reply_func, state: FSMContext):
    await state.clear()
    admin_id = cur.execute("""SELECT full_name, role, is_verified FROM users WHERE telegram_id =?""", (user_id,)).fetchone()
    builder = InlineKeyboardBuilder()
    if admin_id is not None:
        full_name, role, verified = admin_id
        if role == 'administrator':
            for key, value in get_admin_buttons().items():
                builder.add(InlineKeyboardButton(text=value, callback_data=key))
            builder.adjust(1)
            logger.info(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user_name} (ID: {user_id}) —É–≤—ñ–π—à–æ–≤ —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä")
            await reply_func(f'üë®üèª‚Äçüíº {full_name}, –¥–∞–≤–∞–π –ø–æ—á–Ω–µ–º–æ', reply_markup=builder.as_markup())

        elif role == 'doctor' and verified:
            builder.add(InlineKeyboardButton(text='ü©∫ –ú–µ–Ω—é –ª—ñ–∫–∞—Ä—è', callback_data='doc_meny'))
            builder.adjust(1)
            logger.info(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user_name} (ID: {user_id}) —É–≤—ñ–π—à–æ–≤ —è–∫ –ª—ñ–∫–∞—Ä")
            await reply_func(f'üë®‚Äç‚öïÔ∏è –í—ñ—Ç–∞—é –ª—ñ–∫–∞—Ä—é {full_name}, —â–æ –±—É–¥–µ–º–æ —Ä–æ–±–∏—Ç–∏?', reply_markup=builder.as_markup())

    else:
        logger.info(f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user_name} (ID: {user_id}) —É–≤—ñ–π—à–æ–≤ —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á")
        builder.add(InlineKeyboardButton(text='‚úçüèª –ó–∞–ø–∏—Å –¥–æ –ª—ñ–∫–∞—Ä—è', callback_data='record_to_doctor'))
        await reply_func(f'üëã –í—ñ—Ç–∞—é –í–∞—Å {user_name}. –î–∞–≤–∞–π –ø–æ—á–Ω–µ–º–æ', reply_markup=builder.as_markup())


@dp.message(Command("start"))
async def handle_start(message: types.Message, state: FSMContext):
    await show_main_menu(
        user_id=message.from_user.id,
        user_name=message.from_user.first_name,
        reply_func=message.answer,
        state=state
    )

@dp.callback_query(F.data == 'Home')
async def handle_home(callback: types.CallbackQuery, state: FSMContext):
    await show_main_menu(
        user_id=callback.from_user.id,
        user_name=callback.from_user.first_name,
        reply_func=callback.message.answer,
        state=state
    )
    await callback.answer()

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–ª–ª–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö –∞–ø–¥–µ–π—Ç–æ–≤
async def main():
    dp.include_router(admin_router)
    dp.include_router(user_router)
    dp.include_router(doctor_router)
    dp.include_router(test_router)

    tryings = 0
    while True:
        try:
            print("üöÄ Bot run")
            await dp.start_polling(bot)
        except TelegramNetworkError as e:
            tryings += 1
            logger.warning(f"‚ö†Ô∏è TelegramNetworkError: {e}. –°–ø—Ä–æ–±–∞ ‚Ññ{tryings}")
            await asyncio.sleep(1.0 * tryings)
        except Exception as e:
            logger.exception(f"üí• –ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ polling: {e}")
            await asyncio.sleep(5)

if __name__ == "__main__":
    asyncio.run(main())